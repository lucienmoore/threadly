{"version":3,"names":["_classPrivateFieldLooseBase","receiver","privateKey","Object","prototype","hasOwnProperty","call","TypeError","id","_classPrivateFieldLooseKey","name","RequestClient","authErrorStatusCode","tokenStorage","getName","split","map","s","charAt","toUpperCase","slice","join","getOrigin","location","origin","getRegex","value","RegExp","undefined","isOriginAllowed","allowedOrigin","patterns","Array","isArray","some","pattern","test","_refreshingTokenPromise","_getAuthToken","Provider","constructor","uppy","opts","_opts$supportsRefresh","defineProperty","_getAuthToken2","writable","provider","pluginId","tokenKey","companionKeysParams","preAuthToken","supportsRefreshToken","headers","token","Promise","all","authHeaders","btoa","JSON","stringify","params","onReceiveResponse","response","plugin","getPlugin","oldAuthenticated","getPluginState","authenticated","status","setPluginState","setAuthToken","storage","setItem","removeAuthToken","removeItem","ensurePreAuth","fetchPreAuthToken","Error","authQuery","authUrl","_temp","authFormData","query","URLSearchParams","state","set","hostname","loginSimpleAuth","_ref","uppyVersions","signal","post","form","qs","uppyAuthToken","loginOAuth","_ref2","throwIfAborted","resolve","reject","link","authWindow","window","open","cleanup","handleToken","e","source","jsonData","data","err","log","companionAllowedHosts","parse","error","message","i18n","info","close","removeEventListener","addEventListener","login","_ref3","refreshTokenUrl","fileUrl","request","arguments","authTokenAfter","isAuthError","path","method","refreshTokenErr","res","list","directory","options","get","logout","initPlugin","defaultOpts","type","files","serverUrl","serverPattern","companionUrl","replace","URL","getItem"],"sources":["Provider.js"],"sourcesContent":["'use strict'\n\nimport RequestClient, { authErrorStatusCode } from './RequestClient.js'\nimport * as tokenStorage from './tokenStorage.js'\n\n\nconst getName = (id) => {\n  return id.split('-').map((s) => s.charAt(0).toUpperCase() + s.slice(1)).join(' ')\n}\n\nfunction getOrigin() {\n  // eslint-disable-next-line no-restricted-globals\n  return location.origin\n}\n\nfunction getRegex(value) {\n  if (typeof value === 'string') {\n    return new RegExp(`^${value}$`)\n  } if (value instanceof RegExp) {\n    return value\n  }\n  return undefined\n}\n\nfunction isOriginAllowed(origin, allowedOrigin) {\n  const patterns = Array.isArray(allowedOrigin) ? allowedOrigin.map(getRegex) : [getRegex(allowedOrigin)]\n  return patterns\n    .some((pattern) => pattern?.test(origin) || pattern?.test(`${origin}/`)) // allowing for trailing '/'\n}\n\nexport default class Provider extends RequestClient {\n  #refreshingTokenPromise\n\n  constructor(uppy, opts) {\n    super(uppy, opts)\n    this.provider = opts.provider\n    this.id = this.provider\n    this.name = this.opts.name || getName(this.id)\n    this.pluginId = this.opts.pluginId\n    this.tokenKey = `companion-${this.pluginId}-auth-token`\n    this.companionKeysParams = this.opts.companionKeysParams\n    this.preAuthToken = null\n    this.supportsRefreshToken = opts.supportsRefreshToken ?? true // todo false in next major\n  }\n\n  async headers() {\n    const [headers, token] = await Promise.all([super.headers(), this.#getAuthToken()])\n    const authHeaders = {}\n    if (token) {\n      authHeaders['uppy-auth-token'] = token\n    }\n\n    if (this.companionKeysParams) {\n      authHeaders['uppy-credentials-params'] = btoa(\n        JSON.stringify({ params: this.companionKeysParams }),\n      )\n    }\n    return { ...headers, ...authHeaders }\n  }\n\n  onReceiveResponse(response) {\n    super.onReceiveResponse(response)\n    const plugin = this.uppy.getPlugin(this.pluginId)\n    const oldAuthenticated = plugin.getPluginState().authenticated\n    const authenticated = oldAuthenticated ? response.status !== authErrorStatusCode : response.status < 400\n    plugin.setPluginState({ authenticated })\n    return response\n  }\n\n  async setAuthToken(token) {\n    return this.uppy.getPlugin(this.pluginId).storage.setItem(this.tokenKey, token)\n  }\n\n  async #getAuthToken() {\n    return this.uppy.getPlugin(this.pluginId).storage.getItem(this.tokenKey)\n  }\n\n  /** @protected */\n  async removeAuthToken() {\n    return this.uppy.getPlugin(this.pluginId).storage.removeItem(this.tokenKey)\n  }\n\n  /**\n   * Ensure we have a preauth token if necessary. Attempts to fetch one if we don't,\n   * or rejects if loading one fails.\n   */\n  async ensurePreAuth() {\n    if (this.companionKeysParams && !this.preAuthToken) {\n      await this.fetchPreAuthToken()\n\n      if (!this.preAuthToken) {\n        throw new Error('Could not load authentication data required for third-party login. Please try again later.')\n      }\n    }\n  }\n\n  // eslint-disable-next-line class-methods-use-this\n  authQuery() {\n    return {}\n  }\n\n  authUrl({ authFormData, query } = {}) {\n    const params = new URLSearchParams({\n      ...query,\n      state: btoa(JSON.stringify({ origin: getOrigin() })),\n      ...this.authQuery({ authFormData }),\n    })\n\n    if (this.preAuthToken) {\n      params.set('uppyPreAuthToken', this.preAuthToken)\n    }\n\n    return `${this.hostname}/${this.id}/connect?${params}`\n  }\n\n  /** @protected */\n  async loginSimpleAuth({ uppyVersions, authFormData, signal }) {\n    const response = await this.post(`${this.id}/simple-auth`, { form: authFormData }, { qs: { uppyVersions }, signal })\n    this.setAuthToken(response.uppyAuthToken)\n  }\n\n  /** @protected */\n  async loginOAuth({ uppyVersions, authFormData, signal }) {\n    await this.ensurePreAuth()\n\n    signal.throwIfAborted()\n\n    return new Promise((resolve, reject) => {\n      const link = this.authUrl({ query: { uppyVersions }, authFormData })\n      const authWindow = window.open(link, '_blank')\n\n      let cleanup\n\n      const handleToken = (e) => {\n        if (e.source !== authWindow) {\n          let jsonData = ''\n          try {\n            // TODO improve our uppy logger so that it can take an arbitrary number of arguments,\n            // each either objects, errors or strings,\n            // then we donâ€™t have to manually do these things like json stringify when logging.\n            // the logger should never throw an error.\n            jsonData = JSON.stringify(e.data)\n          } catch (err) {\n            // in case JSON.stringify fails (ignored)\n          }\n          this.uppy.log(`ignoring event from unknown source ${jsonData}`, 'warning')\n          return\n        }\n\n        const { companionAllowedHosts } = this.uppy.getPlugin(this.pluginId).opts\n        if (!isOriginAllowed(e.origin, companionAllowedHosts)) {\n          reject(new Error(`rejecting event from ${e.origin} vs allowed pattern ${companionAllowedHosts}`))\n          return\n        }\n\n        // Check if it's a string before doing the JSON.parse to maintain support\n        // for older Companion versions that used object references\n        const data = typeof e.data === 'string' ? JSON.parse(e.data) : e.data\n\n        if (data.error) {\n          const { uppy } = this\n          const message = uppy.i18n('authAborted')\n          uppy.info({ message }, 'warning', 5000)\n          reject(new Error('auth aborted'))\n          return\n        }\n\n        if (!data.token) {\n          reject(new Error('did not receive token from auth window'))\n          return\n        }\n\n        cleanup()\n        resolve(this.setAuthToken(data.token))\n      }\n\n      cleanup = () => {\n        authWindow.close()\n        window.removeEventListener('message', handleToken)\n        signal.removeEventListener('abort', cleanup)\n      }\n\n      signal.addEventListener('abort', cleanup)\n      window.addEventListener('message', handleToken)\n    })\n  }\n\n  async login({ uppyVersions, authFormData, signal }) {\n    return this.loginOAuth({ uppyVersions, authFormData, signal })\n  }\n\n  refreshTokenUrl() {\n    return `${this.hostname}/${this.id}/refresh-token`\n  }\n\n  fileUrl(id) {\n    return `${this.hostname}/${this.id}/get/${id}`\n  }\n\n  /** @protected */\n  async request(...args) {\n    await this.#refreshingTokenPromise\n\n    try {\n      // to test simulate access token expired (leading to a token token refresh),\n      // see mockAccessTokenExpiredError in companion/drive.\n      // If you want to test refresh token *and* access token invalid, do this for example with Google Drive:\n      // While uploading, go to your google account settings,\n      // \"Third-party apps & services\", then click \"Companion\" and \"Remove access\".\n\n      return await super.request(...args)\n    } catch (err) {\n      if (!this.supportsRefreshToken) throw err\n      // only handle auth errors (401 from provider), and only handle them if we have a (refresh) token\n      const authTokenAfter = await this.#getAuthToken()\n      if (!err.isAuthError || !authTokenAfter) throw err\n\n      if (this.#refreshingTokenPromise == null) {\n        // Many provider requests may be starting at once, however refresh token should only be called once.\n        // Once a refresh token operation has started, we need all other request to wait for this operation (atomically)\n        this.#refreshingTokenPromise = (async () => {\n          try {\n            this.uppy.log(`[CompanionClient] Refreshing expired auth token`, 'info')\n            const response = await super.request({ path: this.refreshTokenUrl(), method: 'POST' })\n            await this.setAuthToken(response.uppyAuthToken)\n          } catch (refreshTokenErr) {\n            if (refreshTokenErr.isAuthError) {\n              // if refresh-token has failed with auth error, delete token, so we don't keep trying to refresh in future\n              await this.removeAuthToken()\n            }\n            throw err\n          } finally {\n            this.#refreshingTokenPromise = undefined\n          }\n        })()\n      }\n\n      await this.#refreshingTokenPromise\n\n      // now retry the request with our new refresh token\n      return super.request(...args)\n    }\n  }\n\n  async fetchPreAuthToken() {\n    if (!this.companionKeysParams) {\n      return\n    }\n\n    try {\n      const res = await this.post(`${this.id}/preauth/`, { params: this.companionKeysParams })\n      this.preAuthToken = res.token\n    } catch (err) {\n      this.uppy.log(`[CompanionClient] unable to fetch preAuthToken ${err}`, 'warning')\n    }\n  }\n\n  list(directory, options) {\n    return this.get(`${this.id}/list/${directory || ''}`, options)\n  }\n\n  async logout(options) {\n    const response = await this.get(`${this.id}/logout`, options)\n    await this.removeAuthToken()\n    return response\n  }\n\n  static initPlugin(plugin, opts, defaultOpts) {\n    /* eslint-disable no-param-reassign */\n    plugin.type = 'acquirer'\n    plugin.files = []\n    if (defaultOpts) {\n      plugin.opts = { ...defaultOpts, ...opts }\n    }\n\n    if (opts.serverUrl || opts.serverPattern) {\n      throw new Error('`serverUrl` and `serverPattern` have been renamed to `companionUrl` and `companionAllowedHosts` respectively in the 0.30.5 release. Please consult the docs (for example, https://uppy.io/docs/instagram/ for the Instagram plugin) and use the updated options.`')\n    }\n\n    if (opts.companionAllowedHosts) {\n      const pattern = opts.companionAllowedHosts\n      // validate companionAllowedHosts param\n      if (typeof pattern !== 'string' && !Array.isArray(pattern) && !(pattern instanceof RegExp)) {\n        throw new TypeError(`${plugin.id}: the option \"companionAllowedHosts\" must be one of string, Array, RegExp`)\n      }\n      plugin.opts.companionAllowedHosts = pattern\n    } else if (/^(?!https?:\\/\\/).*$/i.test(opts.companionUrl)) {\n      // does not start with https://\n      plugin.opts.companionAllowedHosts = `https://${opts.companionUrl.replace(/^\\/\\//, '')}`\n    } else {\n      plugin.opts.companionAllowedHosts = new URL(opts.companionUrl).origin\n    }\n\n    plugin.storage = plugin.opts.storage || tokenStorage\n    /* eslint-enable no-param-reassign */\n  }\n}\n"],"mappings":"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"}